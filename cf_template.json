{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Transform":{
      "Name":"AWS::Include",
      "Parameters":{
         "Location":"s3://storage-specialists-cf-templates/regional_ami_mapping.json"
      }
   },
   "Resources":{
      "myVPC":{
         "Type":"AWS::EC2::VPC",
         "Properties":{
            "CidrBlock":"10.11.12.0/24",
            "EnableDnsSupport":"true",
            "EnableDnsHostnames":"true",
            "InstanceTenancy":"default",
            "Tags":[
               {
                  "Key":"Name",
                  "Value":"StoragePerformanceWorkshopVPC"
               }
            ]
         }
      },
      "PublicSubnet1":{
         "Type":"AWS::EC2::Subnet",
         "Properties":{
            "VpcId":{
               "Ref":"myVPC"
            },
            "CidrBlock":"10.11.12.0/24",
            "MapPublicIpOnLaunch":"True",
            "Tags":[
               {
                  "Key":"Name",
                  "Value":"StoragePerformanceWorkshopSubnet"
               }
            ]
         }
      },
      "myInternetGateway":{
         "Type":"AWS::EC2::InternetGateway",
         "Properties":{
            "Tags":[
               {
                  "Key":"Name",
                  "Value":"StoragePerformanceWorkshopVPC"
               }
            ]
         }
      },
      "AttachGateway":{
         "Type":"AWS::EC2::VPCGatewayAttachment",
         "Properties":{
            "VpcId":{
               "Ref":"myVPC"
            },
            "InternetGatewayId":{
               "Ref":"myInternetGateway"
            }
         }
      },
      "myRouteTable":{
         "Type":"AWS::EC2::RouteTable",
         "Properties":{
            "VpcId":{
               "Ref":"myVPC"
            },
            "Tags":[
               {
                  "Key":"Name",
                  "Value":"StoragePerformanceWorkshopVPC"
               }
            ]
         }
      },
      "PublicSubnet1RouteAssociaton":{
         "Type":"AWS::EC2::SubnetRouteTableAssociation",
         "Properties":{
            "SubnetId":{
               "Ref":"PublicSubnet1"
            },
            "RouteTableId":{
               "Ref":"myRouteTable"
            }
         }
      },
      "RoutetoInternet":{
         "Type":"AWS::EC2::Route",
         "DependsOn":"myInternetGateway",
         "Properties":{
            "RouteTableId":{
               "Ref":"myRouteTable"
            },
            "DestinationCidrBlock":"0.0.0.0/0",
            "GatewayId":{
               "Ref":"myInternetGateway"
            }
         }
      },
      "SSHAccessSG":{
         "Type":"AWS::EC2::SecurityGroup",
         "Properties":{
            "GroupDescription":"SSH Access",
            "VpcId":{
               "Ref":"myVPC"
            },
            "SecurityGroupIngress":{
               "IpProtocol":"tcp",
               "FromPort":"22",
               "ToPort":"22",
               "CidrIp":"0.0.0.0/0"
            }
         }
      },
      "EFSSG":{
         "Type":"AWS::EC2::SecurityGroup",
         "Properties":{
            "GroupDescription":"Access to EFS",
            "VpcId":{
               "Ref":"myVPC"
            },
            "SecurityGroupIngress":{
               "IpProtocol":"tcp",
               "FromPort":"2049",
               "ToPort":"2049",
               "CidrIp":"0.0.0.0/0"
            }
         }
      },
      "S3Role":{
         "Type":"AWS::IAM::Role",
         "Properties":{
            "AssumeRolePolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "ec2.amazonaws.com"
                        ]
                     },
                     "Action":[
                        "sts:AssumeRole"
                     ]
                  }
               ]
            },
            "Path":"/"
         }
      },
      "RolePolicies":{
         "Type":"AWS::IAM::Policy",
         "Properties":{
            "PolicyName":"admin",
            "PolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Action":"s3:*",
                     "Resource":"*"
                  }
               ]
            },
            "Roles":[
               {
                  "Ref":"S3Role"
               }
            ]
         }
      },
      "InstanceProfile":{
         "Type":"AWS::IAM::InstanceProfile",
         "Properties":{
            "Path":"/",
            "Roles":[
               {
                  "Ref":"S3Role"
               }
            ]
         }
      },
      "bucket01":{
         "Type":"AWS::S3::Bucket",
         "Properties":{
            "BucketEncryption":{
               "ServerSideEncryptionConfiguration":[
                  {
                     "ServerSideEncryptionByDefault":{
                        "SSEAlgorithm":"AES256"
                     }
                  }
               ]
            }
         }
      },
      "FileSystem":{
         "Type":"AWS::EFS::FileSystem",
         "Properties":{
            "PerformanceMode":"generalPurpose",
            "ThroughputMode":"provisioned",
            "ProvisionedThroughputInMibps":"300",
            "FileSystemTags":[
               {
                  "Key":"Name",
                  "Value":"StoragePerformanceWorkshopFS"
               }
            ]
         }
      },
      "MountTarget":{
         "Type":"AWS::EFS::MountTarget",
         "Properties":{
            "FileSystemId":{
               "Ref":"FileSystem"
            },
            "SubnetId":{
               "Ref":"PublicSubnet1"
            },
            "SecurityGroups":[
               {
                  "Fn::GetAtt":[
                     "EFSSG",
                     "GroupId"
                  ]
               }
            ]
         }
      },
      "Instance01":{
         "Type":"AWS::EC2::Instance",
         "DependsOn":"MountTarget",
         "Properties":{
            "ImageId":{
               "Fn::FindInMap":[
                  "RegionalAmiMap",
                  {
                     "Ref":"AWS::Region"
                  },
                  "AmazonLinux2"
               ]
            },
            "SubnetId":{
               "Ref":"PublicSubnet1"
            },
            "InstanceType":"c5.4xlarge",
            "Tags":[
               {
                  "Key":"Name",
                  "Value":"Storage_Performance_Workshop"
               }
            ],
            "SecurityGroupIds":[
               {
                  "Ref":"SSHAccessSG"
               },
               {
                  "Ref":"EFSSG"
               }
            ],
            "IamInstanceProfile":{
               "Ref":"InstanceProfile"
            },
            "BlockDeviceMappings":[
               {
                  "DeviceName":"/dev/xvda",
                  "Ebs":{
                     "VolumeType":"gp2",
                     "DeleteOnTermination":"true",
                     "VolumeSize":"40"
                  }
               },
               {
                  "DeviceName":"/dev/sdb",
                  "Ebs":{
                     "VolumeType":"gp3",
                     "DeleteOnTermination":"true",
                     "VolumeSize":"100",
                     "Iops": "6000"
                  }
               }
            ],
            "UserData":{
               "Fn::Base64":{
                  "Fn::Join":[
                     "",
                     [
                        "#!/bin/bash -xe\n",
                        "sudo yum update -y\n",
                        "sudo yum install fio amazon-efs-utils git -y\n",
                        "sudo yum install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm\n",
                        "sudo yum install fpart -y\n",
                        "sudo wget https://ftpmirror.gnu.org/parallel/parallel-20191022.tar.bz2\n",
                        "sudo bzip2 -dc parallel-20191022.tar.bz2 | tar xvf -\n",
                        "cd parallel-20191022\n",
                        "sudo ./configure && make && sudo make install\n",
                        "sudo mkfs -t ext4 /dev/nvme1n1\n",
                        "sudo mkdir /ebsperftest\n",
                        "sudo mount /dev/nvme1n1 /ebsperftest\n",
                        "echo '/dev/nvme1n1       /ebsperftest    ext4   defaults,nofail        0   0' | sudo tee -a /etc/fstab\n",
                        "screen -d -m -S fiotest fio --filename=/dev/nvme1n1 --rw=randread --bs=16k --runtime=9600 --time_based=1   --iodepth=32 --ioengine=libaio --direct=1  --name=gp3-16kb-burst-bucket-test\n",
                        "sudo mkdir /efs\n",
                        "sudo chown ec2-user:ec2-user /efs\n",
                        {
                           "Fn::Join":[
                              "",
                              [
                                 "sudo mount -t efs ",
                                 {
                                    "Ref":"FileSystem"
                                 },
                                 ":/ /efs\n"
                              ]
                           ]
                        },
                        "sudo mkdir -p /efs/tutorial/{dd,touch,rsync,cp,parallelcp,parallelcpio}/\n",
                        "sudo chown ec2-user:ec2-user /efs/tutorial/ -R\n",
                        "cd /home/ec2-user/\n",
                        "sudo git clone https://github.com/bengland2/smallfile.git\n",
                        "sudo mkdir -p /ebs/tutorial/{smallfile,data-1m}\n",
                        "sudo chown ec2-user:ec2-user //ebs/tutorial/ -R\n",
                        "echo '#!/bin/bash' > /etc/profile.d/script.sh\n",
                        {
                           "Fn::Join":[
                              "",
                              [
                                 "sudo echo export bucket=",
                                 {
                                    "Ref":"bucket01"
                                 },
                                 " >> /etc/profile.d/script.sh\n"
                              ]
                           ]
                        },
                        "echo 'storage-workshop' | sudo tee -a  /proc/sys/kernel/hostname\n",
                        "python /home/ec2-user/smallfile/smallfile_cli.py --operation create --threads 10 --file-size 1024 --file-size-distribution exponential --files 200 --same-dir N --dirs-per-dir 1024 --hash-into-dirs Y --files-per-dir 10240 --top /ebs/tutorial/smallfile\n",
                        "cp -R /ebs/tutorial/smallfile/file_srcdir/storage-workshop /ebs/tutorial/data-1m/\n"
                     ]
                  ]
               }
            }
         }
      }
   },
   "Outputs":{
      "Bucket":{
         "Value":{
            "Ref":"bucket01"
         }
      },
      "EC2Instance":{
         "Value":{
            "Fn::GetAtt":[
               "Instance01",
               "PublicIp"
            ]
         }
      }
   }
}
